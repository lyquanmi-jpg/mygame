<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>æ‹¯æ•‘ç”·å¤§ï¼šå®¶åº­é£äº‘ç‰ˆ</title>
<style>
    @import url('https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&display=swap');
    
    :root {
        --bg: #1e1e1e; --panel: #2d2d2d; --text: #ecf0f1;
        --gold: #f1c40f; --hp: #ff6b6b; --exp: #1dd1a1; --eng: #ff9f43;
        --ssr: #e17055; --sr: #a29bfe; --r: #74b9ff;
    }

    /* è®©æ•´é¡µå¯ä»¥æ»šåŠ¨ï¼Œé¿å…æ‰‹æœºåº•éƒ¨å·¥å…·æ æŒ¡ä½å†…å®¹ */
    body {
        margin: 0;
        background: var(--bg);
        color: var(--text);
        font-family: 'Roboto Mono', "Microsoft YaHei", sans-serif;
        height: 100%;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        overflow-y: auto;
        user-select: none;
    }
    
    /* HUD */
    /* #hud { padding: 12px; background: var(--panel); border-bottom: 2px solid #000; display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 13px; box-shadow: 0 4px 10px rgba(0,0,0,0.5); z-index: 10; } */
    #hud {
        padding: 12px;
        background: var(--panel);
        border-bottom: 2px solid #000;
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
        font-size: 13px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.5);
        z-index: 10;
    
        /* æ–°å¢ä¸¤è¡Œï¼šè®©çŠ¶æ€æ å¸é¡¶ */
        position: sticky;
        top: 0;
    }

	.stat-row { display: flex; justify-content: space-between; align-items: center; flex-wrap:wrap; gap:4px; }
    .bar-bg { width: 70px; height: 8px; background: #333; border-radius: 4px; overflow: hidden; margin-left: 5px; }
    .bar-fill { height: 100%; transition: width 0.3s; }
    #hp-bar { background: var(--hp); } 
    #eng-bar { background: var(--eng); }

    /* èˆå° */
/*    #stage {
        flex: 1;
        overflow-y: auto;
        padding: 15px;
        padding-bottom: 90px;  /* ç»™åº•éƒ¨æŒ‰é’®ç•™ç©ºé—´ */
        font-size: 14px;
        line-height: 1.6;
        scroll-behavior: smooth;
        background-image: radial-gradient(#333 1px, transparent 1px);
        background-size: 20px 20px;
    } */
    #stage {
        flex: 1;
        /* åŸæ¥æ˜¯ overflow-y: auto; ç°åœ¨æ”¹æˆ visibleï¼Œè®©æ•´é¡µæ»šåŠ¨ */
        overflow-y: visible;
        padding: 15px;
        padding-bottom: 90px; /* ç»™åº•éƒ¨æŒ‰é’®è…¾åœ°æ–¹ */
        font-size: 14px;
        line-height: 1.6;
        scroll-behavior: smooth;
        background-image: radial-gradient(#333 1px, transparent 1px);
        background-size: 20px 20px;
    }

    .card { background: #353b48; padding: 12px; margin-bottom: 10px; border-radius: 8px; border-left: 4px solid #777; animation: popIn 0.3s ease; position: relative; }
    .card.npc { border-color: var(--gold); background: #2f3640; }
    .card.chat { border-color: #3498db; background: #2c3e50; font-style: italic; }
    .card.battle { border-color: var(--hp); background: #2c0000; }
    .card.event { border-color: var(--exp); }
    .card.system { border-color:#7f8c8d; background:#2d3436; }

    .bubble { 
        background: #fff; color: #000; padding: 8px 12px; border-radius: 15px; border-bottom-left-radius: 2px;
        display: inline-block; margin: 5px 0; font-weight: bold; font-size: 13px;
        box-shadow: 2px 2px 5px rgba(0,0,0,0.3);
    }

    /* æŒ‰é’®åŒºï¼šå¸åˆ°åº•éƒ¨ï¼Œå¹¶å…¼å®¹ iPhone åº•éƒ¨å®‰å…¨åŒº */
    #controls {
        padding: 15px;
        padding-bottom: calc(15px + env(safe-area-inset-bottom));
        background: var(--panel);
        border-top: 2px solid #000;
        display: grid;
        gap: 10px;
        position: sticky;
        bottom: 0;
        z-index: 20;
    }
    button { padding: 14px; border: none; border-radius: 8px; font-weight: bold; color: white; font-size: 16px; cursor: pointer; transition: 0.1s; }
    button:active { transform: translateY(2px); }
    .btn-main { background: linear-gradient(135deg, #0984e3, #6c5ce7); }
    .btn-rest { background: linear-gradient(135deg, #e17055, #d63031); }
    .btn-opt { background: #636e72; border: 1px solid #b2bec3; font-size: 14px; padding: 12px; }
    .btn-buy { color: #ffeaa7; border-color: #ffeaa7; }
    .btn-fight { color: #ff7675; border-color: #ff7675; }
    .btn-talk { color: #55efc4; border-color: #55efc4; }
    .btn-small { font-size: 12px; padding: 6px 10px; border-radius: 6px; }

    /* å¼¹çª—ï¼ˆå¤©èµ‹ + ç»“ç®—å…±ç”¨æ ·å¼ï¼‰ */
    #modal, #end-modal {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.95); z-index: 100;
        display: flex; flex-direction: column; justify-content: center; align-items: center;
        padding: 20px; box-sizing:border-box;
    }
    .talent-card { width: 85%; background: #34495e; margin: 8px; padding: 15px; border: 2px solid #555; border-radius: 8px; cursor: pointer; transition: 0.2s; }
    .talent-card:hover { transform: scale(1.02); border-color: white; }
    .hidden { display: none !important; }
    
    #choice-btns { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }

    #end-modal-inner {
        max-width: 480px; width: 96%; background:#2c3e50; border-radius:10px; padding:16px;
        box-shadow: 0 0 16px rgba(0,0,0,0.6); font-size:14px;
    }
    #ach-list { max-height: 220px; overflow-y:auto; margin-top:8px; }
    .ach-item { padding:6px 8px; border-radius:6px; margin-bottom:4px; background:#34495e; display:flex; justify-content:space-between; align-items:center; }
    .ach-item.locked { opacity:0.3; }
    .ach-name { font-weight:bold; }
    .ach-tag { font-size:11px; padding:2px 6px; border-radius:999px; background:#16a085; color:#ecf0f1; }

    @keyframes popIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
</style>
</head>
<body>

<div id="hud">
    <div class="stat-row">
        <span>â¤ï¸ <span id="val-hp">100</span></span>
        <div class="bar-bg"><div id="hp-bar" class="bar-fill" style="width:100%"></div></div>
    </div>
    <div class="stat-row">
        <span>âš¡ <span id="val-eng">100</span></span>
        <div class="bar-bg"><div id="eng-bar" class="bar-fill" style="width:100%"></div></div>
    </div>
    <div class="stat-row" style="grid-column:span 2; border-top:1px solid #444; padding-top:5px; margin-top:5px">
        <span style="color:var(--gold)">ğŸ’° <span id="val-gold">0</span></span>
        <span style="color:#aaa">âš”ï¸ <span id="val-atk">10</span></span>
        <span style="color:var(--exp)">ğŸ† LV.<span id="val-lvl">1</span></span>
        <span style="color:#fdcb6e">ğŸ¥‡ <span id="val-ach">0</span>æš</span>
        <span style="color:#74b9ff">ğŸ¤ <span id="val-allies">0</span>äºº</span>
        <span style="color:#e84393">ğŸ“· <span id="val-danger">0</span>%</span>
    </div>
</div>

<div id="stage"></div>

<div id="controls">
    <button id="main-btn" class="btn-main" onclick="game.explore()">ğŸ² æ¢ç´¢æ ¡å›­ (-10ç²¾åŠ›)</button>
    <button id="rest-btn" class="btn-rest" onclick="game.rest()">ğŸ›Œ å®¿èˆèººå¹³ (+HP & ç²¾åŠ›)</button>
    <div id="choice-btns" class="hidden"></div>
</div>

<!-- å¼€å±€å¤©èµ‹ -->
<div id="modal">
    <h2 style="color:white; margin-bottom:20px">ğŸ”® ä½ çš„å¼€å±€äººè®¾</h2>
    <div id="talent-list" style="width:100%; display:flex; flex-direction:column; align-items:center;"></div>
</div>

<!-- ç»“ç®—é¢æ¿ -->
<div id="end-modal" class="hidden">
    <div id="end-modal-inner">
        <h2 style="margin-top:0;margin-bottom:8px;">ğŸ“š æœ¬å±€æˆç»©å•</h2>
        <div id="summary-text" style="margin-bottom:10px;"></div>
        <h3 style="margin:8px 0;">ğŸ… è§£é”æˆå°±</h3>
        <div id="ach-list"></div>
        <button class="btn-main" style="width:100%; margin-top:10px;" onclick="game.restart()">å†æ•´ä¸€æŠŠï¼ˆé‡æ–°æŠ½äººè®¾ï¼‰</button>
    </div>
</div>

<script>
// --- 1. å¤©èµ‹æ•°æ®åº“ ---
const talents = [
    { name:"å¯ŒäºŒä»£", r:"SSR", desc:"åˆå§‹é‡‘å¸+1000ï¼Œå¼€å±€å°±æ˜¯åˆ«äººçš„äººç”Ÿå·…å³°", effect:p=>p.gold+=1000 },
    { name:"é¾™å‚²å¤©", r:"SSR", desc:"åˆå§‹æ”»å‡»+30ï¼Œå˜´ä¸Šè¯´èººå¹³ï¼Œæ‹³å¤´å¾ˆè¯šå®", effect:p=>p.atk+=30 },
    { name:"å¤©é€‰ä¹‹å­", r:"SSR", desc:"å…¨å±æ€§+20ï¼Œè¿å­¦æ ¡WiFiéƒ½åçˆ±ä½ ", effect:p=>{p.maxHp+=30;p.hp+=30;p.atk+=20;p.gold+=200} },
    { name:"å­¦éœ¸", r:"SR", desc:"å‡çº§é€Ÿåº¦+50%ï¼Œå·æ­»å¯¹æ‰‹ä¸æ‰è¡€", effect:p=>p.expRate=1.5 },
    { name:"å¥èº«ç‹‚", r:"SR", desc:"HPä¸Šé™+80ï¼Œè‡ªå¸¦é˜²çˆ†å°è…¹è‚Œ", effect:p=>{p.maxHp+=80;p.hp+=80} },
    { name:"æ¡æ¼ç‹", r:"R", desc:"åˆå§‹é‡‘å¸+300ï¼ŒäºŒæ‰‹ç¾¤æ°¸è¿œæœ‰ä½ æƒ³è¦çš„", effect:p=>p.gold+=300 },
    { name:"æ™®é€šäºº", r:"N", desc:"å¹³å¹³æ·¡æ·¡æ‰æ˜¯çœŸï¼šæ²¡æœ‰debuffå·²ç»å¾ˆä¸é”™äº†", effect:p=>{} }
];

// --- 2. NPC æ•°æ®åº“ï¼ˆå«æ–°è§’è‰²ï¼šç¤¾äº¤æ‚åŒªæ¡ƒæ±å°å§ï¼‰ ---
const npcDB = [
    { 
        id:"spring", name:"æ˜¥å¤", icon:"ğŸ’ƒ", desc:"På›¾æ˜¯æœ¬ä½“çš„ç¾å°‘å¥³", hp:60, atk:5, treasure:{n:"ç¾é¢œç›¸æœº", p:150, b:"HP+50", e:p=>p.hp+=50},
        lines: {
            greet: ["é›†ç¾ï¼Œæ¥çœ‹çœ‹è¿™å¼ å›¾æ€ä¹ˆä¿®ï¼Ÿ", "ä»Šå¤©å¦†æœ‰ç‚¹å¡ç²‰ï¼Œçƒ¦æ­»ã€‚"],
            talk: ["çº¢å§æœ€è¿‘åœ¨ç»™å¥¹å¥³å„¿æŠ¢å‘¨æ°ä¼¦çš„ç¥¨ï¼Œç«æ°”å¾ˆå¤§ã€‚", "ç”·äººåªä¼šå½±å“æˆ‘På›¾çš„é€Ÿåº¦ã€‚", "å–ç‚¹å¥¶èŒ¶å§ï¼Œè¿™æ¯åªæœ‰ä¸‰åˆ†ç³–ã€‚"],
            fight: ["å•Šï¼æˆ‘çš„å‡ç«æ¯›æ‰äº†ï¼", "åˆ«æ‰“è„¸ï¼æˆ‘åˆšåšçš„åŒ»ç¾ï¼"],
            buy: ["å¥½çœ¼å…‰ï¼ç”¨äº†è¿™ä¸ªä½ ä¹Ÿèƒ½Cä½å‡ºé“ã€‚"]
        }
    },
    { 
        id:"genius", name:"å¤©æ‰å“¥", icon:"ğŸ’»", desc:"å¤´å‘ç¨€ç–çš„èµ›åšå¤§å¸", hp:70, atk:15, treasure:{n:"RTX4090", p:400, b:"æ”»+15", e:p=>p.atk+=15},
        lines: {
            greet: ["404 Not Found. å“¦æ˜¯ä½ å•Šã€‚", "CPUæ¸©åº¦è¿‡é«˜ï¼Œåˆ«æŒ¨æˆ‘å¤ªè¿‘ã€‚"],
            talk: ["æˆ‘é»‘è¿›äº†çº¢å§çš„æ‰‹æœºï¼Œå‘ç°å¥¹ç›¸å†Œé‡Œå…¨æ˜¯å¸…å“¥å·æ‹ç…§ã€‚", "å¥³äººåªä¼šå½±å“æˆ‘æ‹”åˆ€çš„é€Ÿåº¦ï¼Œæ˜¾å¡ä¸ä¼šã€‚", "çº¢å§è€å…¬ä¸Šæ¬¡æ¥é€é¥­ï¼Œçœ‹èµ·æ¥æ˜¯ä¸ªå¦»ç®¡ä¸¥ã€‚"],
            fight: ["å°å°æˆ‘çš„ rm -rf /* æ”»å‡»ï¼", "å†…å­˜æº¢å‡ºå§ï¼"],
            buy: ["è¿™å¯æ˜¯æ¬¡ä¸–ä»£çš„æ€§èƒ½ï¼Œåˆ«æ‹¿å»æŒ–çŸ¿ã€‚"]
        }
    },
    { 
        id:"tianfen", name:"å¤©ä»½å“¥", icon:"ğŸ’¸", desc:"æ”¶æ¬¾ç éšæ—¶å¾…å‘½", hp:50, atk:5, treasure:{n:"æ”¶æ¬¾ç ", p:10, b:"é‡‘å¸+999", e:p=>p.gold+=999},
        lines: {
            greet: ["Væˆ‘50ï¼Œè†å¬æˆ‘çš„å¤ä»‡è®¡åˆ’ã€‚", "ä»Šå¤©åŸºé‡‘ç»¿å¾—åƒæˆ‘çš„å¸½å­ã€‚"],
            talk: ["çº¢å§çš„èƒ¶å·å’Œç›¸æœºéƒ½æ˜¯åˆ†æœŸä¹°çš„ï¼Œè¿˜æ²¡è¿˜å®Œå‘¢ã€‚", "å¬è¯´å¥¹ç°åœ¨æƒ³æŠŠå…¨æ ¡ç”·å¤§æ‹æˆå†™çœŸåˆé›†ã€‚", "åªè¦æˆ‘ä¸çœ‹ä½™é¢ï¼Œæˆ‘å°±æ²¡æœ‰ç ´äº§ã€‚"],
            fight: ["ä½ æ•¢æ‰“æˆ‘ï¼Ÿæˆ‘å¯æ˜¯ä¹°äº†æ„å¤–é™©çš„ï¼", "èµ”é’±ï¼åŒ»è¯è´¹ç»“ä¸€ä¸‹ï¼"],
            buy: ["æ”¯ä»˜å®åˆ°è´¦ï¼Œä¸€äº¿å…ƒï¼(å¹»å¬)"]
        }
    },
    { 
        id:"littleD", name:"å¾¡å§å°D", icon:"ğŸ‘ ", desc:"æ°”åœºä¸¤ç±³å…«çš„å­¦ç”Ÿä¼šä¸»å¸­", hp:100, atk:25, treasure:{n:"å¥³ç‹æ•™é­", p:300, b:"æ”»+20", e:p=>p.atk+=20},
        lines: {
            greet: ["æŠŠè…°æŒºç›´ï¼åƒä»€ä¹ˆæ ·å­ï¼", "è¿Ÿåˆ°äº†ä¸‰åˆ†é’Ÿï¼Œè®°è¿‡ä¸€æ¬¡ã€‚"],
            talk: ["çº¢å§è¯´è¦æ•´é¡¿â€œå¸…å“¥é£æ°”â€ï¼Œå‡†å¤‡æç»Ÿä¸€ç€è£…ã€‚", "åˆ«å¤ªå‹‰å¼ºè‡ªå·±ï¼Œæœ‰å›°éš¾...å¯ä»¥æ¥æ‰¾æˆ‘ã€‚", "å¥¹æœ€è¿‘æ‹¿ç€ç›¸æœºåˆ°å¤„å·¡é€»ï¼Œä½ è¦å°å¿ƒç‚¹ã€‚"],
            fight: ["è·ªä¸‹ï¼", "ä¸å¬è¯çš„åå­©å­éœ€è¦æƒ©ç½šã€‚"],
            buy: ["æ‹¿å»ï¼Œå¥½å¥½ç”¨ï¼Œåˆ«ç»™æˆ‘ä¸¢äººã€‚"]
        }
    },
    { 
        id:"couple", name:"çªçªå¥‡å¥‡", icon:"ğŸ’•", desc:"è¿ä½“å©´æƒ…ä¾£", hp:150, atk:12, treasure:{n:"æƒ…ä¾£å¯¹æˆ’", p:250, b:"HPä¸Šé™+30", e:p=>{p.maxHp+=30;p.hp+=30}},
        lines: {
            greet: ["äº²çˆ±çš„~å¼ å˜´ï¼Œå•Š~", "ä½ æ€ä¹ˆæ˜¯ä¸€ä¸ªäººï¼Ÿå¥½å¯æ€œã€‚"],
            talk: ["çº¢å§æƒ³æ‹ä¸€å¥—â€œæ ¡å›­æƒ…ä¾£å†™çœŸâ€ï¼Œæˆ‘ä»¬ç›´æ¥æ‹’ç»äº†ã€‚", "æˆ‘ä»¬ä¹Ÿæ¥å¸®å¿™ï¼Œç”·å¥³æ­é…å¹²æ´»ä¸ç´¯ï¼", "å¥¹å¥½åƒåªå¯¹å¸…å“¥æ„Ÿå…´è¶£ï¼Œä½ ç®—åŠä¸ªå®‰å…¨åŒºã€‚"],
            fight: ["æ··åˆåŒæ‰“ï¼", "å•èº«ç‹—å—æ­»å§ï¼"],
            buy: ["ç¥ä½ ä¹Ÿæ—©æ—¥æ‰¾åˆ°å¦ä¸€åŠã€‚"]
        }
    },
    { 
        id:"dream", name:"æ ¡åŒ»å°æ¢¦", icon:"ğŸ’‰", desc:"ç¬‘å¾—å¾ˆç”œï¼Œä¸‹æ‰‹å¾ˆé‡", hp:90, atk:35, treasure:{n:"å¼ºæ•ˆéº»é†‰é’ˆ", p:250, b:"HPå›æ»¡", e:p=>p.hp=p.maxHp},
        lines: {
            greet: ["å“ªé‡Œä¸èˆ’æœï¼Ÿè¿˜æ˜¯æƒ³ä»¥æ­¤ä¸ºå€Ÿå£é€ƒè¯¾ï¼Ÿ", "æ¥ï¼Œå¼ å˜´ï¼Œå•Šâ€”â€”"],
            talk: ["çº¢å§å¸¸æ¥æˆ‘è¿™å†²æ´—èƒ¶å·ï¼Œä¸€å·æ¯”ä¸€å·å¸…ã€‚", "æ¥ï¼Œåƒé¢—ç³–ï¼Œåˆšæ‰æ‰“é’ˆä¸ç–¼å§ï¼Ÿ", "å¥¹è¯´è¦æŠŠä½ åˆ—å…¥â€œé‡ç‚¹æ‹æ‘„å¯¹è±¡â€ï¼Œè‡ªå·±å½“å¿ƒç‚¹ã€‚"],
            fight: ["è¿™ä¸€é’ˆä¸‹å»ï¼Œä½ ä¼šç¡å¾—å¾ˆé¦™ã€‚", "åˆ«åŠ¨ï¼Œæ‰åäº†å¯ä¸è´Ÿè´£ï¼"],
            buy: ["æ³¨æ„å‰‚é‡ï¼Œåˆ«æŠŠè‡ªå·±å¼„æ­»äº†ã€‚"]
        }
    },
    { 
        id:"vjie", name:"Vå§", icon:"ğŸº", desc:"96åº¦ç”Ÿå‘½ä¹‹æ°´çˆ±å¥½è€…", hp:120, atk:18, treasure:{n:"ä¼ç‰¹åŠ ", p:200, b:"HPä¸Šé™+50", e:p=>{p.maxHp+=50;p.hp+=50}},
        lines: {
            greet: ["å—~ å…„å¼Ÿï¼Œèµ°ä¸€ä¸ªï¼Ÿ", "è¿™åœ°æ€ä¹ˆåœ¨æ™ƒå•Š...æ‰¶æˆ‘èµ·æ¥ï¼"],
            talk: ["çº¢å§é…’é‡ä¸è¡Œï¼Œä½†æ‹ç…§æ‹å¾—å¾ˆç–¯ã€‚", "å¥¹è¯´è¦åŠâ€œå¸…å“¥å½±å±•â€ï¼Œå…¨æ ¡ç”·å¤§éƒ½åœ¨å€™é€‰åå•é‡Œã€‚", "æ„Ÿæƒ…æ·±ï¼Œä¸€å£é—·ï¼"],
            fight: ["æˆ‘æ²¡é†‰ï¼æˆ‘è¿˜èƒ½æ‰“åä¸ªï¼", "å°å°æˆ‘çš„é†‰æ‹³ï¼å‘•..."],
            buy: ["å¥½é…’ï¼å¤ŸåŠ²ï¼å¹²äº†ï¼"]
        }
    },
    { 
        id:"jojo", name:"Jojoå§", icon:"ğŸŒŸ", desc:"è‡ªå¸¦BGMçš„å¥‡å¦™å¥³äºº", hp:150, atk:40, treasure:{n:"çŸ³é¬¼é¢", p:666, b:"å…¨å±+20", e:p=>{p.atk+=20;p.maxHp+=20;p.hp+=20}},
        lines: {
            greet: ["JOâ€”â€”JOâ€”â€”ï¼", "è´«å¼±ï¼è´«å¼±ï¼"],
            talk: ["çº¢å§çš„æ„å›¾è¿˜è¡Œï¼Œå°±æ˜¯å®¡ç¾æœ‰ç‚¹ç—…å¨‡ã€‚", "åšäººæœ€é‡è¦çš„å°±æ˜¯å§¿æ€è¦å¸…ï¼", "å¥¹æ‹ç…§åƒè€ƒå¤ï¼šåªæ”¶å¸…å“¥æ ·æœ¬ã€‚"],
            fight: ["æ¬§æ‹‰æ¬§æ‹‰æ¬§æ‹‰ï¼", "æˆ‘ä¸åšäººäº†ï¼"],
            buy: ["æ‹¿å»å§ï¼Œè¿™å¯æ˜¯è¶…è¶Šäººç±»çš„åŠ›é‡ã€‚"]
        }
    },
    { 
        id:"egg", name:"å¨å¸ˆè›‹æ€»", icon:"ğŸ³", desc:"æŒæ¡è‚‰é‡åˆ†é…æƒçš„ç”·äºº", hp:160, atk:18, treasure:{n:"ç„é“é»‘é”…", p:200, b:"HP+40", e:p=>{p.maxHp+=40;p.hp+=40}},
        lines: {
            greet: ["è¦é¥­è¿˜æ˜¯é¢ï¼Ÿ", "æ‰‹åˆ«æŠ–ï¼Œç›˜å­æ‹¿ç¨³äº†ã€‚"],
            talk: ["çº¢å§ä¼šç»™å¸…å“¥åŠ ä¸€å‹ºèœï¼Œå…¶ä»–äººå°±â€¦â€¦æ­£å¸¸æ°´å¹³ã€‚", "çœ‹ä½ ç˜¦çš„ï¼Œå¤šåƒç‚¹ã€‚", "å¬è¯´å¥¹æƒ³é å†™çœŸé›†ä¾›å¥³å„¿ä¸Šå­¦ã€‚"],
            fight: ["çœ‹æˆ‘çš„é¢ å‹ºå¤§æ³•ï¼", "æŠŠä½ ç‚’æˆå›é”…è‚‰ï¼"],
            buy: ["è¶çƒ­åƒï¼Œå‡‰äº†å°±ä¸å¥½åƒäº†ã€‚"]
        }
    },

    /* æ–° NPCï¼šç¤¾äº¤æ‚åŒªæ¡ƒæ±å°å§ */
    { 
        id:"peach", name:"ç¤¾äº¤æ‚åŒªæ¡ƒæ±", icon:"ğŸ§ƒ", desc:"å˜´ç”œåˆ€å¿«çš„ç¤¾äº¤å°å¤©æ‰", hp:85, atk:14,
        treasure:{n:"çˆ†æ–™å°æœ¬æœ¬", p:220, b:"æ¯æ¬¡åŠ å¥½æ„Ÿé¢å¤–+1", e:p=>{p.favorBonus=(p.favorBonus||0)+1}},
        lines: {
            greet: ["ä½ è°å•Šï¼Ÿç­‰ä¼šå„¿ï¼Œå…ˆåŠ ä¸ªå¥½å‹ã€‚", "æˆ‘åˆšæŠŠéš”å£å®¿èˆç¾¤èŠç‚¸äº†åæ¡ï¼Œä½ è¦çœ‹çœ‹å—ï¼Ÿ"],
            talk: [
                "çº¢å§å…¶å®äººä¸åï¼Œå°±æ˜¯å¯¹å¸…å“¥çš„å®šä¹‰æœ‰ç‚¹å®½æ³›ã€‚",
                "æˆ‘æ‹‰äº†ä¸€ä¸ªã€åå†™çœŸè”ç›Ÿç¾¤ã€‘ï¼Œä½ è¦ä¸è¦è¿›ï¼Ÿ",
                "æ”¾å¿ƒï¼Œæœ‰æˆ‘åœ¨ï¼Œå¥¹åœ¨å®¶é•¿ç¾¤é‡Œå‘ä½ é»‘ç…§æˆ‘èƒ½ç»™ä½ åœ†å›æ¥ã€‚"
            ],
            fight: [
                "ä½ åˆ«çœŸæ‰“å•Šï¼Œæˆ‘å˜´ä¸Šè¯´è¯´çš„ï¼",
                "å“å“Ÿï¼Œç¤¾äº¤æ‚åŒªä¹Ÿæ˜¯æœ‰è¡€æœ‰è‚‰çš„ï¼"
            ],
            buy: [
                "è¿™æœ¬å°æœ¬æœ¬é‡Œå…¨æ˜¯é‡ç‚¹ç´ æï¼Œç”¨å¥½äº†èƒ½è®©å…¨æ ¡éƒ½å¸®ä½ ç«™é˜Ÿã€‚"
            ]
        }
    },

    { 
        id:"yang", name:"æ‘„å½±å¸ˆé˜³é˜³", icon:"ğŸ“¸", desc:"å–„äºå‘ç°ç¾çš„(å·æ‹)çœ¼ç›", hp:70, atk:12, treasure:{n:"é•¿ç„¦é•œå¤´", p:350, b:"æ”»+18", e:p=>p.atk+=18},
        lines: {
            greet: ["åˆ«åŠ¨ï¼è¿™ä¸ªå…‰çº¿æ­£å¥½ï¼", "ç¬‘ä¸€ä¸‹ï¼ŒèŒ„å­~"],
            talk: ["æˆ‘è·Ÿçº¢å§æŠ¢æœºä½ï¼Œå¥¹ä¸“é—¨å¯¹å‡†å¸…å“¥ï¼Œæˆ‘è´Ÿè´£æ‹åˆ«äººã€‚", "ä½ è¿™æˆ˜æ–—å§¿åŠ¿æŒºå¸…çš„ï¼Œæˆ‘ç»™ä½ æ‹ä¸€å¼ ã€‚", "å¥¹çš„é•œå¤´é‡Œå·²ç»å¡æ»¡äº†ç”·å¤§ã€‚"],
            fight: ["é—ªå…‰ç¯è‡´ç›²ï¼", "è¿™ä¸€è„šå¾ˆè´µçš„ï¼åˆ«ç¢°å™¨æï¼"],
            buy: ["ç”¨å®ƒå»å‘ç°ä¸–ç•Œçš„çœŸç›¸å§ã€‚"]
        }
    },
    { 
        id:"snail", name:"æ‘©å‹èœ—ç‰›", icon:"ğŸï¸", desc:"é£ä¸€æ ·çš„è‡ªç”±çµé­‚", hp:90, atk:30, treasure:{n:"é¬¼ç«æ’æ°”ç®¡", p:150, b:"æ”»+12", e:p=>p.atk+=12},
        lines: {
            greet: ["è½°è½°è½°â€”â€”ï¼", "ä¸Šè½¦å—ï¼Ÿå¸¦ä½ å…œé£ã€‚"],
            talk: ["çº¢å§è¿½ç€å¸…å“¥æ»¡æ ¡å›­è·‘ï¼Œå·®ç‚¹è¢«æˆ‘è½¦å¸¦ç¿»ã€‚", "åªè¦æˆ‘éª‘å¾—å¤Ÿå¿«ï¼Œå¥¹å°±åªèƒ½æ‹åˆ°å°¾ç¯ã€‚", "è¿™è½¦é™¤äº†é“ƒé“›ä¸å“ï¼Œå“ªéƒ½å“ã€‚"],
            fight: ["åƒæˆ‘å°¾æ°”å§ï¼", "æ°®æ°”åŠ é€Ÿï¼"],
            buy: ["è£…ä¸Šè¿™ä¸ªï¼Œæ•´æ¡è¡—ä½ æœ€åµã€‚"]
        }
    },
    { 
        id:"wenting", name:"æ–‡å©·", icon:"ğŸ“ˆ", desc:"é«˜å†·é‡‘èå¤©æ‰", hp:80, atk:10, treasure:{n:"å†…å¹•æ¶ˆæ¯", p:500, b:"é‡‘å¸+800", e:p=>p.gold+=800},
        lines: {
            greet: ["æ—¶é—´å°±æ˜¯é‡‘é’±ï¼Œä½ æµªè´¹äº†æˆ‘ä¸‰ç§’ã€‚", "ä½ æ˜¯æ¥èèµ„çš„å—ï¼Ÿ"],
            talk: ["æŒ‰å¥¹ç°åœ¨çš„æ‹æ‘„é€Ÿåº¦ï¼Œå†è¿‡åŠå¹´ï¼Œå…¨æ ¡å¸…å“¥éƒ½è¦è¢«â€œæ”¶å…¥å›¾å†Œâ€ã€‚", "è¿™æœ‰ä¸€æ”¯æ½œåŠ›è‚¡ï¼Œæˆ‘åªå‘Šè¯‰ä½ ä¸€ä¸ªäººã€‚", "å¤åˆ©æ˜¯ä¸–ç•Œç¬¬å…«å¤§å¥‡è¿¹ã€‚"],
            fight: ["æˆ‘è¦åšç©ºä½ çš„äººç”Ÿï¼", "è®©ä½ è§è¯†èµ„æœ¬çš„åŠ›é‡ï¼"],
            buy: ["è¿™æ˜¯ä¸€ç¬”ç¨³å¥çš„æŠ•èµ„ã€‚"]
        }
    },
    { 
        id:"melon", name:"å®ç®±æ€ªä¸œç“œ", icon:"ğŸ“¦", desc:"(æš—ä¸­è§‚å¯Ÿ.jpg)", hp:180, atk:22, treasure:{n:"é»„é‡‘å‡ç‰™", p:999, b:"å…¨å±+10", e:p=>{p.atk+=10;p.maxHp+=50;p.hp+=50}},
        lines: {
            greet: ["(ç®±å­å¾®å¾®åŠ¨äº†ä¸€ä¸‹)", "ğŸ‘€"],
            talk: ["(å®ƒåå‡ºä¸€å¼ å·æ‹ç…§ï¼šä¸€å †ç”·å¤§è¢«æ’é˜Ÿåˆå½±)", "å’•å™œå’•å™œ...(å®ƒè§‰å¾—ä½ æ˜¯ä¸ªå¥½äºº)", "(å®ƒå±•ç¤ºäº†è‡ªå·±é”‹åˆ©çš„ç‰™é½¿)"],
            fight: ["å—·å‘œï¼(å’¬æ­»ä½ ï¼)", "ç °ï¼(ç®±ç›–å¤¹æ‰‹æ”»å‡»)"],
            buy: ["(å®ƒå¼€å¿ƒåœ°åå‡ºäº†å®ç‰©)"]
        }
    },
    { 
        id:"ache", name:"é˜¿æ¾ˆ", icon:"ğŸš¬", desc:"å……æ»¡æ•…äº‹çš„é€€å½¹ç”·å¤§", hp:110, atk:28, treasure:{n:"æ—§å‰ä»–", p:180, b:"æ”»+10", e:p=>p.atk+=10},
        lines: {
            greet: ["(åå‡ºä¸€å£çƒŸåœˆ)...", "å¤§å­¦ç”Ÿæ´»ï¼Œä¹Ÿå°±é‚£æ ·å§ã€‚"],
            talk: ["æˆ‘é‚£ä¸€å±Šçš„å¸…å“¥ï¼Œå·²ç»è¢«å¥¹æ‹æˆä¸¤æœ¬ç”»å†Œäº†ã€‚", "è¿™é¦–æ­Œé€ç»™ä½ ï¼Œå¸Œæœ›èƒ½ç»™ä½ åŠ›é‡ã€‚", "åˆ«åƒæˆ‘ä¸€æ ·ï¼Œç­‰åˆ°å¤±å»äº†æ‰åæ‚”ã€‚"],
            fight: ["ç”Ÿæ´»æ¯”æ‹³å¤´æ›´ç—›ã€‚", "åˆ«é€¼æˆ‘åŠ¨æ‰‹ã€‚"],
            buy: ["æ‹¿å»å§ï¼Œå®ƒå·²ç»ä¸å±äºæˆ‘äº†ã€‚"]
        }
    }
];

// --- 3. çº¢å§ BOSSï¼šäºŒæ®µå˜èº« ---
const bossHong = {
    name: "æ•™å¯¼ä¸»ä»»çº¢å§",
    icon: "ğŸ“·",
    maxHp: 260,
    hp: 260,
    atk: 40,
    lines: {
        intro: [
            "ä»Šå¤©çš„ç›®æ ‡æ˜¯â€”â€”æŠŠå…¨æ ¡å¸…å“¥æ‹å®Œã€‚ä½ ï¼Œç«™é‚£åˆ«åŠ¨ï¼",
            "é•œå¤´å¯¹å‡†ä½ äº†ï¼Œå°ä¼™å­ï¼Œç¬‘ä¸€ä¸ªâ€”â€”è¦æ°¸è¿œç•™åœ¨ç›¸å†Œé‡Œçš„é‚£ç§ã€‚"
        ],
        fight: [
            "å¥½å¥½é…åˆï¼Œæˆ‘ä¼šæŠŠä½ æ‹å¾—å¾ˆå¸…çš„ã€‚",
            "ä½ è·‘ä»€ä¹ˆï¼Ÿæˆ‘åªæ˜¯æƒ³ç»™ä½ â€œç»ˆèº«å†™çœŸâ€ã€‚",
            "åˆ«åŠ¨ï¼æ¨¡ç³Šäº†å°±å¾—é‡æ‹ä¸€ç™¾å¼ ã€‚"
        ],
        fight2: [
            "å®¶é•¿ç¾¤å·²ç»å‡†å¤‡å¥½çœ‹ä½ ç…§ç‰‡äº†ï¼Œä½ è¿˜æƒ³è·‘ï¼Ÿ",
            "ä»Šå¤©ä¸æ‹å®Œä½ ï¼Œæˆ‘éƒ½ä¸å¥½æ„æ€è·Ÿæˆ‘å¥³å„¿äº¤ä»£ã€‚",
            "æˆ‘ç°åœ¨æ‹çš„ä¸åªæ˜¯è„¸ï¼Œæ˜¯ä½ æ•´ä¸ªäººç”Ÿçš„è½¨è¿¹ã€‚"
        ],
        transform: [
            "è¡Œï¼Œé‚£å°±åˆ«æ€ªæˆ‘å¼€å®¶é•¿ç¾¤ç°åœºç›´æ’­äº†ã€‚",
            "æ—¢ç„¶å¥½è¯´å¥½å•†é‡ä¸è¡Œï¼Œé‚£å°±èµ°æµç¨‹å§â€”â€”æ•™å¯¼ä¸»ä»»çš„æµç¨‹ã€‚"
        ],
        kill: [
            "å’”åš“â€”â€”æ­å–œï¼Œä½ è¢«æ”¶å…¥ã€Šç”·å¤§å…¸è—é›†ã€‹ã€‚",
            "å®¶é•¿ä»¬éƒ½è¯´ï¼Œä½ ä¸Šé•œå°±è¡Œï¼Œå­¦ä¹ ä¸€èˆ¬æ²¡å…³ç³»ã€‚"
        ],
        lose: [
            "åŸæ¥â€¦â€¦ä¸æ˜¯æ‰€æœ‰å¸…å“¥éƒ½èƒ½è¢«æ”¶è—å•Šã€‚",
            "é‚£å°±æŠŠç›¸æœºç•™ç»™ä½ ä»¬å§ï¼Œå»æ‹å±äºä½ ä»¬è‡ªå·±çš„æ•…äº‹ã€‚"
        ]
    }
};

// --- 4. æˆå°±ç³»ç»Ÿ ---
const achievementDB = [
    { id:"FIRST_STEP", name:"å‹‡æ•¢è¿ˆå‡ºå®¿èˆé—¨", desc:"ç¬¬ä¸€æ¬¡æ¢ç´¢æ ¡å›­ã€‚", check:g=>g.stats.explores>=1 },
    { id:"CHAT_KING", name:"å®¿èˆæ°´ç¾¤ç‹", desc:"å’ŒNPCæ‰¯æ·¡è‡³å°‘ 5 æ¬¡ã€‚", check:g=>g.stats.chats>=5 },
    { id:"FIGHTER", name:"æ‹³å¤´å³æ­£ä¹‰", desc:"ä¸»åŠ¨æ NPC è‡³å°‘ 3 æ¬¡ã€‚", check:g=>g.stats.fights>=3 },
    { id:"PACIFIST", name:"éæš´åŠ›ä¸åˆä½œ", desc:"é€šå…³å‰ä»æœªä¸»åŠ¨æè¿‡ NPCã€‚", check:g=>g.state.gameOver && g.stats.fights===0 },
    { id:"RICH", name:"å°é•‡åœŸè±ªç”·å¤§", desc:"æœ¬å±€é‡‘å¸æœ€é«˜çºªå½• â‰¥ 1000ã€‚", check:g=>g.stats.maxGold>=1000 },
    { id:"EVENT_LOVER", name:"æ ¡å›­äº‹ä»¶æ”¶é›†è€…", desc:"éšæœºäº‹ä»¶è§¦å‘è‡³å°‘ 6 æ¬¡ã€‚", check:g=>g.stats.events>=6 },
    { id:"LOW_HP", name:"æ‰“ä¸æ­»çš„å°å¼º", desc:"è¡€é‡æ›¾è·Œåˆ° 10 ä»¥ä¸‹ä½†ä»ç„¶æ´»åˆ°äº†ç»“å±€ã€‚", check:g=>g.state.gameOver && g.stats.lowHpSurvive },
    { id:"SHOPAHOLIC", name:"å¿«ä¹å‰æ‰‹å…š", desc:"å’Œ NPC æˆåŠŸäº¤æ˜“è‡³å°‘ 3 æ¬¡ã€‚", check:g=>g.stats.trades>=3 },
    { id:"MEET_BOSS", name:"è§å®¶é•¿ç°åœº", desc:"é­é‡è¿‡çº¢å§ä¹±å…¥ã€‚", check:g=>g.boss.appeared },
    { id:"BEAT_BOSS", name:"åå‘å®¶é•¿ä¼š", desc:"åœ¨åŒç›Ÿæ”¯æ´ä¸‹å‡»è´¥çº¢å§ã€‚", check:g=>g.boss.defeated },
    { id:"ALLY_MASTER", name:"å…¨æ ¡ç»Ÿä¸€æˆ˜çº¿", desc:"è‡³å°‘æœ‰ 5 ä½ NPC å¥½æ„Ÿåº¦ â‰¥ 3ã€‚", check:g=>Object.values(g.npcFavor).filter(v=>v>=3).length>=5 },
    { id:"PEACH_ALLY", name:"æ¡ƒå‘³ç¤¾äº¤å®‰å…¨å¸¦", desc:"è®©ç¤¾äº¤æ‚åŒªæ¡ƒæ±å°å§åŠ å…¥åŒç›Ÿï¼ˆå¥½æ„Ÿâ‰¥3ï¼‰ã€‚", check:g=>g.npcFavor.peach>=3 },
    { id:"PHASE2", name:"é»‘åŒ–ä¹Ÿè¦æ‰“æ»¡", desc:"è§è¯çº¢å§äºŒé˜¶æ®µé»‘åŒ–å˜èº«ã€‚", check:g=>g.boss.transformed }
];

// --- 5. éŸ³æ•ˆ ---
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
const sfx = { 
    blip: ()=>pt(800,'square',0.05),
    coin: ()=>pt(1200,'sine',0.1),
    hit: ()=>pt(150,'sawtooth',0.1),
    chat: ()=>pt(600,'sine',0.1,100),
    alert: ()=>pt(300,'square',0.2,100)
};
function pt(f,t,d,s=0){
    try{
        if(audioCtx.state === 'suspended') audioCtx.resume();
        const o = audioCtx.createOscillator();
        const g = audioCtx.createGain();
        o.type = t;
        o.frequency.setValueAtTime(f, audioCtx.currentTime);
        if(s){
            o.frequency.linearRampToValueAtTime(f + s, audioCtx.currentTime + d);
        }
        g.gain.setValueAtTime(0.1, audioCtx.currentTime);
        g.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + d);
        o.connect(g);
        g.connect(audioCtx.destination);
        o.start();
        o.stop(audioCtx.currentTime + d);
    }catch(e){}
}

// --- 6. æ¸¸æˆæ ¸å¿ƒå¼•æ“ ---
const game = {
    player: { hp:100, maxHp:100, atk:10, gold:0, lvl:1, exp:0, maxExp:100, expRate:1, energy:100, favorBonus:0 },
    stats: { explores:0, chats:0, trades:0, fights:0, wins:0, losses:0, runaways:0, events:0, maxGold:0, lowHpSurvive:false, seen:{} },
    boss: { appeared:false, defeated:false, allies:[], transformed:false },
    achievementsUnlocked: {},
    npcFavor: {}, // id -> å¥½æ„Ÿåº¦
    currentNPC: null,
    mode: "normal", // normal / npc / boss
    talentName: "",
    state: { gameOver:false },
    danger: 0,
    maxDanger: 100,

    // åˆå§‹åŒ–ï¼šæ˜¾ç¤ºå¤©èµ‹å¼¹çª—
    init: () => {
        const list = document.getElementById('talent-list');
        list.innerHTML = "";
        talents.sort(() => 0.5 - Math.random()).slice(0, 3).forEach(t => {
            const div = document.createElement('div');
            div.className = "talent-card";
            div.style.borderColor = t.r === 'SSR' ? '#f39c12' : (t.r === 'SR' ? '#a29bfe' : '#555');
            div.innerHTML = `<b>[${t.r}] ${t.name}</b><br><small>${t.desc}</small>`;
            div.onclick = () => game.start(t);
            list.appendChild(div);
        });

        // æ˜¾ç¤ºæŠ½äººè®¾å¼¹çª—
        document.getElementById('modal').classList.remove('hidden');
        document.getElementById('end-modal').classList.add('hidden');

        // é‡ç½®æŒ‰é’®å’Œæ¨¡å¼ï¼Œæ¸…æ‰ä¸Šä¸€å±€çš„ BOSS æŒ‰é’®
        const choice = document.getElementById('choice-btns');
        choice.classList.add('hidden');
        choice.innerHTML = "";
        document.getElementById('main-btn').classList.remove('hidden');
        document.getElementById('rest-btn').classList.remove('hidden');
        game.mode = "normal";

        // æŠ½äººè®¾æ—¶å…ˆæŠŠåº•éƒ¨æŒ‰é’®æ•´ä¸ªè—èµ·æ¥ï¼Œé¿å…è¯¯ç‚¹
        document.getElementById('controls').classList.add('hidden');
        document.getElementById('hud').style.opacity = 1;
    },

    // å¼€å§‹æ¸¸æˆï¼ˆè½¯é‡å¼€ï¼‰
    start: (talent) => {
        // å…³æ‰æŠ½äººè®¾å¼¹çª—ï¼Œé‡æ–°æ˜¾ç¤ºåº•éƒ¨æŒ‰é’®
        document.getElementById('modal').classList.add('hidden');
        document.getElementById('controls').classList.remove('hidden');

        // æ¸…ç©ºèˆå°
        document.getElementById('stage').innerHTML = "";

        // é‡ç½®ç©å®¶å’Œå…¨å±€çŠ¶æ€
        game.player = { hp:100, maxHp:100, atk:10, gold:0, lvl:1, exp:0, maxExp:100, expRate:1, energy:100, favorBonus:0 };
        game.stats = { explores:0, chats:0, trades:0, fights:0, wins:0, losses:0, runaways:0, events:0, maxGold:0, lowHpSurvive:false, seen:{} };
        game.boss = { appeared:false, defeated:false, allies:[], transformed:false };
        game.achievementsUnlocked = {};
        game.npcFavor = {};
        npcDB.forEach(n => game.npcFavor[n.id] = 0);
        game.mode = "normal";
        game.state.gameOver = false;
        game.talentName = talent.name;
        game.danger = 0;

        // åº”ç”¨å¤©èµ‹
        talent.effect(game.player);

        game.log(`âœ¨ æ–°çš„äººç”Ÿå·²åŠ è½½ï¼å¤©èµ‹ [${talent.name}] ç”Ÿæ•ˆã€‚`, "system");
        game.log(`ğŸ« èƒŒæ™¯ç®€ä»‹ï¼š<br>æ•™å¯¼ä¸»ä»»ã€çº¢å§ã€‘è¿·ä¸Šç”¨ç›¸æœºâ€œæ”¶è—â€å…¨æ ¡å¸…å“¥ï¼Œå·²ç»æŠŠä¸€åŠç”·å¤§æ‹è¿›äº†å¥¹çš„ç§äººå†™çœŸé›†ã€‚å‰©ä¸‹çš„ï¼Œå°±çœ‹ä½ èƒ½ä¸èƒ½è”åˆ 14+1 ä½ NPCï¼Œé›†é½å‹æƒ…ä¹‹åŠ›ä¸€èµ·åæ€å¥¹ã€‚`, "event");
        game.updateUI();
    },

    // ä¿®æ”¹å¥½æ„Ÿåº¦ï¼ˆè€ƒè™‘æ¡ƒæ±å°æœ¬æœ¬çš„åŠ æˆï¼‰
    changeFavor: (npcId, delta) => {
        if(!(npcId in game.npcFavor)) game.npcFavor[npcId]=0;
        const old = game.npcFavor[npcId];
        const bonus = game.player.favorBonus || 0;
        let effDelta = delta;
        if(delta>0 && bonus>0) effDelta += bonus; // æ¯æ¬¡æ­£å‘å¥½æ„Ÿå¤šåŠ ä¸€ç‚¹
        const now = Math.max(0, old + effDelta);
        game.npcFavor[npcId] = now;

        if(delta !== 0){
            const npcName = (npcDB.find(n=>n.id===npcId)?.name) || npcId;
            game.log(`ğŸ’™ ä¸ [${npcName}] å¥½æ„Ÿåº¦ ${effDelta>0?'+':''}${effDelta}ï¼ˆå½“å‰ ${now}ï¼‰`, "system");
        }
        game.updateUI();
    },

    // è®¡ç®—å½“å‰åŒç›Ÿæ•°
    getAlliesCount: () => {
        return Object.values(game.npcFavor).filter(v=>v>=3).length;
    },

    // æ¢ç´¢é€»è¾‘ï¼ˆå¸¦â€œè­¦æˆ’å€¼â€ï¼‰
    explore: () => {
        if(game.state.gameOver) return;
        if(game.player.energy < 10) { game.log("ğŸ˜´ ç²¾åŠ›ä¸è¶³ï¼Œå†è–…ä¸‹å»è¦çŒæ­»äº†ï¼Œå¿«å›å®¿èˆèººå¹³ã€‚", "system"); return; }
        sfx.blip();
        game.player.energy -= 10;
        game.stats.explores++;

        // å‡é«˜è­¦æˆ’å€¼ï¼šæ¢ç´¢è¶Šä¹…ï¼Œçº¢å§è¶Šå®¹æ˜“å¯Ÿè§‰
        game.danger = Math.min(game.maxDanger, game.danger + 8);

        // å½“æ¢ç´¢æ¬¡æ•°>=6 ä¸”è­¦æˆ’å€¼æ»¡æ ¼æ—¶ï¼Œå¿…å®šè§¦å‘ BOSSï¼Œé¿å…åˆšå¼€å±€å°±è¢«æŠ“
        if(!game.boss.appeared && !game.state.gameOver && game.stats.explores>=6 && game.danger>=game.maxDanger){
            game.startBossEncounter();
            game.updateUI();
            return;
        }

        const rng = Math.random();
        if(rng < 0.7) {
            game.triggerNPC();
        } else {
            const events = [
                {t:"ä½ åœ¨è‡ªä¹ å®¤åº§ä½ç¼éš™é‡Œæ‘¸åˆ°ä¸€å¼ çš±å·´å·´çš„çº¢åŒ…ã€‚", e:p=>{p.gold+=50; return "ğŸ’° é‡‘å¸+50ï¼Œæ„Ÿè°¢å‰ä»»æˆ¿å®¢çš„çˆ±"} },
                {t:"çªç„¶æƒ³èµ·ä»Šæ™šæœ‰ ddlï¼Œå¿ƒç‡é£™å‡ã€‚", e:p=>{p.hp-=5; return "ğŸ˜± ç„¦è™‘æš´å‡» HP-5"} },
                {t:"é£Ÿå ‚é˜¿å§¨æ‰‹ä¸€æŠ–ï¼Œå¤šå¡äº†åŠå‹ºè‚‰ã€‚", e:p=>{p.hp+=20; return "ğŸ– è‚‰è‚‰æ²»æ„ˆå¿ƒçµ HP+20"} },
                {t:"ä½ æ›¿é™Œç”ŸåŒå­¦æ¡èµ·æ‰åœ°ä¸Šçš„å­¦ç”Ÿè¯ï¼Œå¯¹æ–¹å¡äº†ä½ ä¸€ç“¶é¥®æ–™ã€‚", e:p=>{p.hp+=10; return "ğŸ§ƒ å¥½äººä¸€ç”Ÿå¹³å®‰ HP+10"} },
                {
                    t:"ä½ è¢«ç¤¾äº¤æ‚åŒªæ¡ƒæ±æ‹‰è¿›äº†ä¸€ä¸ªå¥‡æ€ªçš„å®¿èˆç¾¤èŠã€‚",
                    e:p=>{
                        const target = npcDB[Math.floor(Math.random()*npcDB.length)];
                        game.changeFavor(target.id,1);
                        return `ğŸ§ƒ ç¾¤èŠæ°”æ°›è¿‡äºçƒ­çƒˆï¼Œä½ å’Œ ${target.name} çš„å…³ç³»å¾®å¦™åœ°æ‹‰è¿‘äº†ä¸€ç‚¹ã€‚`;
                    }
                }
            ];
            const ev = events[Math.floor(Math.random()*events.length)];
            const res = ev.e(game.player);
            game.stats.events++;
            game.log(`ğŸ’¡ ${ev.t}<br>â¡ ${res}`, "event");
        }
        game.updateUI();
        game.checkAchievements();
    },

    rest: () => {
        if(game.state.gameOver) return;
        game.player.energy = 100;
        game.player.hp = Math.min(game.player.maxHp, game.player.hp + 40);
        // ä¼‘æ¯ä¹Ÿä¼šè®©â€œè¢«æŠ“æ‹çš„æ¦‚ç‡â€é™ä¸€ç‚¹
        game.danger = Math.max(0, game.danger - 15);
        game.log("ğŸ›Œ ä½ åœ¨å®¿èˆèººå¹³åˆ·çŸ­è§†é¢‘ï¼Œä¸€è§‰é†’æ¥æ‰‹æœºåœ¨è‚šå­ä¸Šï¼Œç²¾ç¥è¿˜è¡Œã€‚", "chat");
        game.updateUI();
        game.checkAchievements();
    },

    // æ™®é€š NPC é­é‡ï¼ˆä¼˜å…ˆé‡åˆ°æ²¡è§è¿‡çš„ï¼‰
    triggerNPC: () => {
        // æŒ‘æœªè§è¿‡/å°‘è§çš„ NPC ä¼˜å…ˆåˆ·æ–°
        const unseen = npcDB.filter(n=>!game.stats.seen[n.id]);
        let pool;
        if(unseen.length>0 && Math.random()<0.7){
            pool = unseen;
        }else{
            pool = npcDB;
        }
        const npc = pool[Math.floor(Math.random()*pool.length)];
        game.currentNPC = { ...npc };
        game.mode = "npc";

        // æ ‡è®°ä¸ºå·²è§è¿‡
        game.stats.seen[npc.id] = true;

        const greet = npc.lines.greet[Math.floor(Math.random() * npc.lines.greet.length)];
        const favorNow = game.npcFavor[npc.id] || 0;
        const favorText = `<div style="font-size:12px;opacity:0.7;margin-top:4px;">å½“å‰å¥½æ„Ÿåº¦ï¼š${favorNow}ï¼ˆâ‰¥3 æ—¶ä¼šåŠ å…¥ä½ çš„å¯¹æŠ—çº¢å§åŒç›Ÿï¼‰</div>`;
        game.logCard(npc, `<div class="bubble">${greet}</div>${favorText}`, "npc");
        
        document.getElementById('main-btn').classList.add('hidden');
        document.getElementById('rest-btn').classList.add('hidden');
        document.getElementById('choice-btns').classList.remove('hidden');
        game.renderBtns();
    },

    renderBtns: () => {
        const box = document.getElementById('choice-btns');
        const npc = game.currentNPC;
        if(game.mode==="npc"){
            box.innerHTML = `
                <button class="btn-opt btn-talk" onclick="game.talk()">ğŸ’¬ æ‰¯æ·¡å¢è¿›æ„Ÿæƒ…</button>
                <button class="btn-opt btn-buy" onclick="game.buy()">ğŸ’° äº¤æ˜“ ${npc.treasure.p} é‡‘å¸</button>
                <button class="btn-opt btn-fight" onclick="game.fight()">âš”ï¸ ä»¥æ­¦ä¼šå‹</button>
                <button class="btn-opt" onclick="game.leave()">ğŸƒ æºœäº†æºœäº†</button>
            `;
        }else if(game.mode==="boss"){
            box.innerHTML = `
                <button class="btn-opt btn-fight" onclick="game.bossFight()">âš”ï¸ ç¡¬åˆšå†™çœŸç‹‚é­”</button>
                <button class="btn-opt btn-talk" onclick="game.bossBeg()">ğŸ™ è£…æ­»è®¤æ€‚</button>
            `;
        }
    },

    talk: () => {
        if(game.mode!=="npc") return;
        sfx.chat();
        const npc = game.currentNPC;
        const line = npc.lines.talk[Math.floor(Math.random() * npc.lines.talk.length)];
        game.log(`<div class="bubble">${line}</div>`, "chat");
        
        const exp = Math.floor(20 * game.player.expRate);
        game.player.exp += exp;
        if(game.player.exp >= game.player.maxExp) game.lvlUp();
        game.log(`ğŸ’¡ ä½ ä»å…«å¦ä¸­æ±²å–äº†äººç”Ÿç»éªŒ +${exp}`, "system");
        game.stats.chats++;
        game.changeFavor(npc.id, 1);

        game.leave();
        game.checkAchievements();
    },

    buy: () => {
        if(game.mode!=="npc") return;
        const npc = game.currentNPC;
        const t = npc.treasure;
        if(game.player.gold >= t.p) {
            sfx.coin();
            game.player.gold -= t.p;
            t.e(game.player);
            const line = npc.lines.buy[0];
            game.log(`<div class="bubble">${line}</div>`, "chat");
            game.log(`âœ… è·å¾— [${t.n}] (${t.b})`, "event");
            game.stats.trades++;
            game.changeFavor(npc.id, 2);
            game.leave();
        } else {
            game.log(`ğŸ’¸ é’±ä¸å¤Ÿï¼ä½ ç¿»äº†ç¿»å£è¢‹ï¼Œåªæ‘¸åˆ°å‡ å¼ å¤–å–å°ç¥¨ã€‚`, "system");
        }
        game.updateUI();
        game.checkAchievements();
    },

    fight: () => {
        if(game.mode!=="npc") return;
        const npc = game.currentNPC;
        const p = game.player;
        sfx.hit();
        
        const taunt = npc.lines.fight[Math.floor(Math.random() * npc.lines.fight.length)];
        game.log(`<div class="bubble">${taunt}</div>`, "battle");

        const dmg = Math.floor(p.atk * 1.5);
        npc.hp -= dmg;
        game.log(`ğŸ‘Š ä½ å¯¹ ${npc.name} é€ æˆ ${dmg} ä¼¤å®³ï¼`, "battle");
        game.stats.fights++;

        if(npc.hp <= 0) {
            game.log(`ğŸ† ä½ èµ¢äº†ï¼é¡ºæ‰‹æ‘¸èµ°äº† [${npc.treasure.n}]ï¼Œè¿˜ä»è£¤å…œé‡Œæå‡º 50 é‡‘å¸ã€‚`, "event");
            npc.treasure.e(p);
            p.gold += 50;
            p.exp += 50;
            game.stats.wins++;
            game.changeFavor(npc.id, 1); // ä»¥æ­¦ä¼šå‹
            if(p.exp >= p.maxExp) game.lvlUp();
            game.leave();
        } else {
            const hurt = Math.floor(npc.atk * 0.8);
            p.hp -= hurt;
            game.log(`ğŸ’¢ å¯¹æ–¹åå‡»ï¼ä½ åƒäº† ${hurt} ç‚¹ä¼¤å®³ã€‚`, "battle");
            if(p.hp <= 0) {
                game.stats.losses++;
                game.updateUI();
                game.gameOver(`ä½ è¢« ${npc.name} æ‰“åˆ°æ€€ç–‘äººç”Ÿï¼Œè¢«æŠ¬å»æ ¡åŒ»é™¢æŒ‚æ°´ã€‚`);
                return;
            } else {
                game.leave();
            }
        }
        game.updateUI();
        game.checkAchievements();
    },

    lvlUp: () => {
        sfx.coin();
        game.player.lvl++;
        game.player.exp -= game.player.maxExp;
        game.player.maxExp = Math.floor(game.player.maxExp * 1.5);
        game.player.maxHp += 20;
        game.player.hp = game.player.maxHp;
        game.player.atk += 5;
        game.log(`ğŸ‰ ç­‰çº§æå‡ï¼ç°åœ¨æ˜¯ LV.${game.player.lvl} â€”â€” çœ‹èµ·æ¥æ›´åƒå¤§ä¸‰è€ç‹—äº†ã€‚`, "event");
    },

    leave: () => {
        document.getElementById('main-btn').classList.remove('hidden');
        document.getElementById('rest-btn').classList.remove('hidden');
        document.getElementById('choice-btns').classList.add('hidden');
        game.mode = "normal";
        game.updateUI();
    },

    // çº¢å§ Boss ä¹±å…¥
    startBossEncounter: () => {
        game.boss.appeared = true;
        game.boss.transformed = false;
        bossHong.hp = bossHong.maxHp;
        game.mode = "boss";
        game.danger = game.maxDanger; // è­¦æˆ’å€¼æ‹‰æ»¡

        // ç»Ÿè®¡åŒç›Ÿ
        const allies = npcDB.filter(n=>game.npcFavor[n.id]>=3);
        game.boss.allies = allies;

        let atkBonus = allies.length * 5;
        let hpBonus = allies.length * 20;
        if(allies.length>0){
            game.player.atk += atkBonus;
            game.player.maxHp += hpBonus;
            game.player.hp += hpBonus;
            game.log(`ğŸ¤ ä½ çš„å‘¼å£°ä¼ éæ ¡å›­ï¼š${allies.length} ä½ NPC å†³å®šç«™åœ¨ä½ è¿™è¾¹ï¼ŒåˆåŠ›å¯¹æŠ—çº¢å§ï¼<br>æ”»å‡» +${atkBonus}ï¼ŒHPä¸Šé™ +${hpBonus}`, "event");
        }else{
            game.log(`ğŸ˜¨ ä½ å‘ç°è‡ªå·±å­¤èº«ä¸€äººèµ°è¿›äº†å®¶é•¿ä¼šç°åœºâ€¦â€¦ä¹Ÿä¸æ˜¯ä¸è¡Œï¼Œå°±æ˜¯æœ‰ç‚¹éš¾åº¦ã€‚`, "system");
        }

        const intro = bossHong.lines.intro[Math.floor(Math.random()*bossHong.lines.intro.length)];
        game.logCard(bossHong, `<div class="bubble">${intro}</div>`, "battle");
        game.log(`ğŸ§¨ å‰§æƒ…äº‹ä»¶ï¼šå†™çœŸç‹‚é­”ã€çº¢å§ã€‘ä¹±å…¥ï¼Œå¥¹æƒ³æŠŠä½ å½“æˆä¸‹ä¸€å¼ â€œå‹è½´å¤§ä½œâ€ã€‚`, "system");

        document.getElementById('main-btn').classList.add('hidden');
        document.getElementById('rest-btn').classList.add('hidden');
        document.getElementById('choice-btns').classList.remove('hidden');
        game.renderBtns();
        game.checkAchievements(); // è§åˆ°çº¢å§å°±èƒ½æ‹¿ä¸€ä¸ªæˆå°±
        game.updateUI();
    },

    // ==== åŒç›Ÿæœ‰å„è‡ªæŠ€èƒ½çš„ BOSS æˆ˜ + äºŒæ®µå˜èº« ====
    bossFight: () => {
        if(game.mode!=="boss" || game.state.gameOver) return;
        const p = game.player;
        const b = bossHong;
        sfx.hit();

        let tauntPool = b.lines.fight;
        if(game.boss.transformed && b.lines.fight2) tauntPool = b.lines.fight2;
        const taunt = tauntPool[Math.floor(Math.random()*tauntPool.length)];
        game.log(`<div class="bubble">${taunt}</div>`, "battle");

        // åŒç›Ÿåˆ—è¡¨ï¼ˆå¯è¢«äºŒé˜¶æ®µâ€œæŠ“èµ°â€ï¼‰
        let allies = game.boss.allies || [];

        // äºŒé˜¶æ®µç‰¹æ®Šæœºåˆ¶ï¼šæœ‰æ¦‚ç‡æŠ“èµ°ä¸€åå¥½æ„Ÿæœ€é«˜çš„åŒç›Ÿæ‹å•äººå†™çœŸï¼Œç¦»åœº
        if(game.boss.transformed && allies.length>0 && Math.random()<0.35){
            // æŒ‘å¥½æ„Ÿæœ€é«˜çš„ä¸€ä¸ª
            let best = allies[0];
            for(let i=1;i<allies.length;i++){
                if((game.npcFavor[allies[i].id]||0) > (game.npcFavor[best.id]||0)){
                    best = allies[i];
                }
            }
            allies = allies.filter(a=>a.id!==best.id);
            game.boss.allies = allies;
            game.npcFavor[best.id] = Math.max(0, (game.npcFavor[best.id]||0)-3);
            game.log(`ğŸ“· çº¢å§è¶ä¹±æŠŠã€${best.name}ã€‘æ‹‰å»å•ç‹¬æ‹â€œç§æˆ¿å†™çœŸâ€ï¼Œæš‚æ—¶é€€å‡ºæˆ˜å±€ï¼Œå¥½æ„Ÿåº¦ -3ï¼`, "battle");
        }

        // ä½ å…ˆæ‰‹ï¼šåŸºç¡€ä¼¤å®³
        const baseDmg = Math.floor(p.atk * 1.2);
        b.hp -= baseDmg;
        game.log(`ğŸ‘Š ä½ é¼“èµ·å‹‡æ°”åæŠ—å†™çœŸç‹‚é­”ï¼Œå¯¹çº¢å§é€ æˆ ${baseDmg} ä¼¤å®³ï¼`, "battle");

        // ==== åŒç›Ÿæ”¯æ´ï¼šæ ¹æ®ä¸åŒ NPC è§¦å‘ä¸åŒæ•ˆæœ ====
        let roundBossAtk = b.atk;    // æœ¬å›åˆçº¢å§æ”»å‡»åŠ›ï¼ˆå¯è¢«å‰Šå¼±ï¼‰
        let dodge = false;           // æ˜¯å¦å®Œå…¨é—ªé¿æœ¬å›åˆæ”»å‡»
        let extraDmg = 0;            // åŒç›Ÿé¢å¤–ä¼¤å®³
        let totalHeal = 0;           // åŒç›Ÿæ€»å›å¤
        let supportLogs = [];

        if(allies.length > 0){
            allies.forEach(ally => {
                const f = game.npcFavor[ally.id] || 0; // å¥½æ„Ÿåº¦ï¼Œå½±å“æ•°å€¼

                switch(ally.id){
                    case "spring": // æ˜¥å¤ï¼šæŸ”å…‰æ»¤é•œå‰Šå¼±æ”»å‡»
                        roundBossAtk -= 5;
                        supportLogs.push("ğŸ’ƒ æ˜¥å¤ç»™çº¢å§å¥—ä¸Šâ€œæŸ”å…‰ç¾é¢œæ»¤é•œâ€ï¼Œå¥¹ä¸‹æ‰‹æ¸©æŸ”äº†ä¸€ç‚¹ï¼ˆæœ¬å›åˆæ”»å‡»-5ï¼‰ã€‚");
                        break;

                    case "genius": // å¤©æ‰å“¥ï¼šé»‘è¿›ç›¸æœºæ‰“é«˜é¢ä¼¤å®³
                        {
                            const d = 8 + Math.floor(f * 1.5);
                            extraDmg += d;
                            supportLogs.push(`ğŸ’» å¤©æ‰å“¥è¿œç¨‹å…¥ä¾µç›¸æœºï¼Œè®©ä¼ æ„Ÿå™¨è¿‡è½½ï¼Œé€ æˆ ${d} ç‚¹é¢å¤–ä¼¤å®³ã€‚`);
                        }
                        break;

                    case "tianfen": // å¤©ä»½å“¥ï¼šæŠŠè¡¥è¯¾ç­é€€è´¹ç»™ä½ 
                        {
                            const gAdd = 30 + f * 10;
                            p.gold += gAdd;
                            totalHeal += 5;
                            supportLogs.push(`ğŸ’¸ å¤©ä»½å“¥å¸®ä½ æŠŠâ€œå½¢è±¡ç®¡ç†è¯¾â€é€€äº† ${gAdd} é‡‘å¸ï¼Œè¿˜é¡ºæ‰‹å¡äº†ç“¶ç»´ç”Ÿç´ ï¼ˆHP+5ï¼‰ã€‚`);
                        }
                        break;

                    case "littleD": // å°Dï¼šæˆ˜æœ¯æŒ‡æŒ¥
                        supportLogs.push("ğŸ‘  å¾¡å§å°Dåœ¨åæ’æŒ‡æŒ¥æˆ˜æœ¯ï¼Œä½ çš„æ”»å‡»å§¿åŠ¿è¢«çº æ­£å¾—å¾ˆæ ‡å‡†ï¼Œæœ¬å›åˆè¾“å‡ºæ›´ç¨³å®šã€‚");
                        break;

                    case "couple": // æƒ…ä¾£ï¼šå¥¶ä¸€å£å›è¡€
                        {
                            const heal = 10 + f * 2;
                            totalHeal += heal;
                            supportLogs.push(`ğŸ’• çªçªå¥‡å¥‡ç»™ä½ çŒäº†ä¸€å£â€œçˆ±æƒ…èƒ½é‡é¥®æ–™â€ï¼Œä¸ºä½ å›å¤ ${heal} ç‚¹HPã€‚`);
                        }
                        break;

                    case "dream": // å°æ¢¦ï¼šå¼ºæ•ˆæ²»ç–—
                        {
                            const heal = Math.floor(p.maxHp * 0.12) + 10;
                            totalHeal += heal;
                            supportLogs.push(`ğŸ’‰ æ ¡åŒ»å°æ¢¦ç°åœºç»™ä½ æ‰“äº†ä¸€é’ˆåŠ å¼ºé’ˆï¼Œå›å¤ ${heal} ç‚¹HPã€‚`);
                        }
                        break;

                    case "vjie": // Vå§ï¼šæœ‰æ¦‚ç‡æŠŠçº¢å§çŒé†‰ï¼Œç åŠæ”»å‡»
                        {
                            if(Math.random() < 0.3){
                                roundBossAtk = Math.floor(roundBossAtk * 0.5);
                                supportLogs.push("ğŸº Vå§ç»™çº¢å§é€’ä¸Šâ€œå‹æƒ…å°é…’â€ï¼Œå¥¹æœ‰ç‚¹ä¸Šå¤´ï¼Œæœ¬å›åˆæ”»å‡»å‡åŠã€‚");
                            }else{
                                supportLogs.push("ğŸº Vå§åœ¨ä¸€æ—è‡ªå—¨å–é…’ï¼Œæ°”æ°›ç»„+1ï¼Œå¯¹æˆ˜å±€æ²¡æœ‰å¤ªå¤§å½±å“ã€‚");
                            }
                        }
                        break;

                    case "jojo": // Jojoï¼šçˆ†å‘å‹é¢å¤–ä¼¤å®³
                        {
                            const d = 12 + f * 2;
                            extraDmg += d;
                            supportLogs.push(`ğŸŒŸ Jojoå§æ‘†å‡ºå¥‡å¦™å§¿åŠ¿ï¼Œé«˜å–Šâ€œä½ å·²ç»è¢«æˆ‘çœ‹ç©¿äº†ï¼â€ï¼Œé€ æˆ ${d} ç‚¹æ›¿èº«ä¼¤å®³ã€‚`);
                        }
                        break;

                    case "egg": // è›‹æ€»ï¼šé€çƒ­èœå›è¡€
                        {
                            const heal = 8 + f * 2;
                            totalHeal += heal;
                            supportLogs.push(`ğŸ³ å¨å¸ˆè›‹æ€»ç»™ä½ ç«¯æ¥ä¸€ç›˜åŠ é‡ç³–é†‹æ’éª¨ï¼ŒHP å›å¤ ${heal}ã€‚`);
                        }
                        break;

                    case "peach": // æ¡ƒæ±ï¼šç¤¾äº¤çˆ†ç ´ï¼Œå¼ºè¡Œè®©æ°”æ°›å°´å°¬
                        {
                            const d = 6 + f * 2;
                            extraDmg += d;
                            roundBossAtk -= 8;
                            supportLogs.push(`ğŸ§ƒ ç¤¾äº¤æ‚åŒªæ¡ƒæ±åœ¨å®¶é•¿ç¾¤é‡Œè¿å‘è¯­éŸ³è´¨ç–‘è¯„åˆ†æ ‡å‡†ï¼Œé€ æˆ ${d} ç‚¹ç²¾ç¥ä¼¤å®³ï¼Œæœ¬å›åˆçº¢å§æ”»å‡» -8ã€‚`);
                        }
                        break;

                    case "yang": // é˜³é˜³ï¼šé—ªå…‰ç¯è‡´ç›²ï¼Œè¿›ä¸€æ­¥å‰Šå¼±æ”»å‡»
                        {
                            roundBossAtk -= 5;
                            const d = 5 + Math.floor(f * 1.2);
                            extraDmg += d;
                            supportLogs.push(`ğŸ“¸ æ‘„å½±å¸ˆé˜³é˜³ç”¨é—ªå…‰ç¯è‡´ç›²çº¢å§ï¼Œé¡ºä¾¿é¡ºæ‰‹æ‹ä¸‹é»‘ç…§ï¼Œé€ æˆ ${d} ç‚¹ä¼¤å®³ï¼Œæ”»å‡»-5ã€‚`);
                        }
                        break;

                    case "snail": // èœ—ç‰›ï¼šæœ‰æ¦‚ç‡è®©ä½ å®Œå…¨é—ªé¿
                        {
                            if(Math.random() < 0.3){
                                dodge = true;
                                supportLogs.push("ğŸï¸ æ‘©å‹èœ—ç‰›å¸¦ä½ åŸåœ°å¼¹å°„èµ·æ­¥ï¼Œæœ¬å›åˆæˆåŠŸç”©å¼€çº¢å§æ”»å‡»ï¼ˆå®Œå…¨é—ªé¿ï¼‰ã€‚");
                            }else{
                                const d = 6 + f;
                                extraDmg += d;
                                supportLogs.push(`ğŸï¸ èœ—ç‰›åœ¨ä¾§é¢æ‹‰ä»‡æ¨ï¼Œå‘åŠ¨â€œé¬¼ç«å°¾æ°”æ”»å‡»â€ï¼Œé€ æˆ ${d} ç‚¹ä¼¤å®³ã€‚`);
                            }
                        }
                        break;

                    case "wenting": // æ–‡å©·ï¼šé€é’±+æ´—ç™½èˆ†è®º
                        {
                            const gAdd = 40 + f * 15;
                            p.gold += gAdd;
                            supportLogs.push(`ğŸ“ˆ æ–‡å©·å¸®ä½ åšäº†ä¸€ä»½â€œå½¢è±¡é£é™©è¯„ä¼°æŠ¥å‘Šâ€ï¼Œå®¶é•¿ä¼šèˆ†è®ºç¨å¾®æ‰­è½¬ï¼Œä½ é¡ºæ‰‹èµšåˆ° ${gAdd} é‡‘å¸çš„ç²¾ç¥èµ”å¿ã€‚`);
                        }
                        break;

                    case "melon": // ä¸œç“œï¼šç®±ç›–å¤¹æ‰‹ä¼¤å®³
                        {
                            const d = 10 + f;
                            extraDmg += d;
                            supportLogs.push(`ğŸ“¦ å®ç®±æ€ªä¸œç“œçªç„¶åˆä¸Šç®±ç›–å¤¹ä½äº†çº¢å§çš„è„šï¼Œé€ æˆ ${d} ç‚¹ä¼¤å®³ã€‚`);
                        }
                        break;

                    case "ache": // é˜¿æ¾ˆï¼šå‘åˆ€ç‰‡è¨€è®ºï¼Œæ°¸ä¹…ç•¥å¾®é™æ”»
                        {
                            roundBossAtk -= 3;
                            supportLogs.push("ğŸš¬ é˜¿æ¾ˆåœ¨ä¸€æ—å¼¹ç€å‰ä»–å”±â€œé’æ˜¥å°±æ˜¯ç”¨æ¥åæ‚”çš„â€ï¼Œçº¢å§ç¬é—´å…±æƒ…ï¼Œæœ¬å›åˆæ”»å‡»-3ã€‚");
                        }
                        break;

                    default:
                        break;
                }
            });

            if(extraDmg > 0){
                b.hp -= extraDmg;
            }
            if(totalHeal > 0){
                p.hp = Math.min(p.maxHp, p.hp + totalHeal);
            }
            roundBossAtk = Math.max(0, roundBossAtk);

            const summaryLine = `ï¼ˆåˆè®¡é¢å¤–ä¼¤å®³ ${extraDmg}ï¼Œæ²»ç–— ${totalHeal}ï¼Œæœ¬å›åˆçº¢å§æ”»å‡»åŠ› ${roundBossAtk}ï¼‰`;
            game.log(`ğŸ“£ åŒç›Ÿæ”¯æ´ï¼š<br>${supportLogs.join("<br>")}<br>${summaryLine}`, "battle");
        }

        // ==== äºŒæ®µå˜èº«è§¦å‘ï¼šè¡€é‡ä½äº 50% ä¸”å°šæœªé»‘åŒ– ====
        if(!game.boss.transformed && b.hp > 0 && b.hp <= b.maxHp/2){
            game.boss.transformed = true;
            // çˆ†æ°”ï¼šå›è¡€ä¸€ç‚¹ & æ”»å‡»åŠ›çŒ›æ¶¨
            const oldAtk = b.atk;
            b.hp += 80;
            b.atk += 20;
            const tline = b.lines.transform[Math.floor(Math.random()*b.lines.transform.length)];
            game.log(`<div class="bubble">${tline}</div>`,"battle");
            game.log(`ğŸ’¢ çº¢å§å½»åº•é»‘åŒ–ï¼Œæ‘„å½±æ¨¡å¼åˆ‡æ¢ä¸ºã€è¿æ‹+å®¶é•¿ç¾¤å¹¿æ’­ã€‘ï¼æ”»å‡» ${oldAtk} âœ ${b.atk}ï¼Œè¿˜é æ„å¿—åŠ›ç¡¬æ’‘äº†ä¸€å£æ°”ã€‚`,"battle");
            game.checkAchievements();
        }

        // ==== ä¼¤å®³ç»“ç®—åï¼Œå†åˆ¤å®šæ˜¯å¦çœŸæ­£å€’ä¸‹ ====
        if(b.hp <= 0){
            game.log(`<div class="bubble">${b.lines.lose[Math.floor(Math.random()*b.lines.lose.length)]}</div>`, "battle");
            game.boss.defeated = true;
            p.exp += 120;
            p.gold += 200;
            game.log(`ğŸ† ä½ å’Œå…¨æ ¡åŒç›Ÿä¸€èµ·ï¼ŒæˆåŠŸç»ˆç»“äº†ç”·å¤§å†™çœŸè®¡åˆ’ï¼è·å¾— 200 é‡‘å¸ä¸â€œçœŸæ­£çš„è‡ªç”±â€ã€‚`, "event");
            game.updateUI();
            game.checkAchievements();
            game.gameOver("ä½ ä»¬è¯´æœäº†çº¢å§ï¼ŒæŠŠç›¸æœºäº¤ç»™å­¦ç”Ÿä»¬å…±åŒç®¡ç†ï¼Œæœ¬å±€è§†ä¸ºã€çœŸÂ·åˆåŠ›ç»“å±€ã€‘ã€‚");
            return;
        }

        // ==== çº¢å§åå‡» ====
        let finalBossAtk = Math.max(0, roundBossAtk);
        if(dodge){
            game.log("ğŸ˜ åœ¨åŒç›Ÿçš„éªšæ“ä½œåŠ æŒä¸‹ï¼Œä½ ä¸€ä¸ªé—ªèº«èº²è¿‡äº†çº¢å§æœ¬å›åˆå…¨éƒ¨æ”»å‡»ã€‚", "battle");
        }else if(finalBossAtk <= 0){
            game.log("ğŸ˜´ çº¢å§è¢«ä½ ä»¬æå¾—å¿ƒåŠ›äº¤ç˜ï¼Œè¿™å›åˆåªå‰©ä¸‹å¹æ°”çš„åŠ›æ°”ï¼Œæ²¡æ‰“æˆä½ ã€‚", "battle");
        }else{
            const hurt = Math.floor(finalBossAtk * 1.1);
            p.hp -= hurt;
            game.log(`ğŸ’¥ çº¢å§ä¸€æ‹›â€œè¿æ‹è¿é—®â€ï¼Œä½ å—åˆ° ${hurt} ä¼¤å®³ï¼Œç²¾ç¥é˜²å¾¡è¢«å‡»ç©¿ã€‚`, "battle");

            if(p.hp <= 0){
                game.log(`<div class="bubble">${b.lines.kill[Math.floor(Math.random()*b.lines.kill.length)]}</div>`, "battle");
                game.stats.losses++;
                game.updateUI();
                game.gameOver("ä½ è¢«å®šæ ¼åœ¨ç›¸çº¸ä¸Šï¼Œæˆä¸ºã€Šç”·å¤§å…¸è—é›†ã€‹çš„å‹è½´ä½œå“ã€‚");
                return;
            }
        }

        game.updateUI();
        game.checkAchievements();
    },

    bossBeg: () => {
        if(game.mode!=="boss" || game.state.gameOver) return;
        game.log("ğŸ™ ä½ é€‰æ‹©è£…æ­»è®¤æ€‚ï¼Œç–¯ç‹‚ç‚¹å¤´è¯´è‡ªå·±å¹¶ä¸ç®—å¸…ï¼Œæ±‚æ”¾è¿‡ã€‚", "battle");
        const penalty = Math.min(game.player.gold, 150);
        game.player.gold -= penalty;
        game.updateUI();
        game.checkAchievements();
        game.gameOver("ä½ æˆåŠŸèº²è¿‡ä¸€åŠ«ï¼Œä½†ä»æ­¤åœ¨å¥¹çš„é•œå¤´å‰ä¸æ•¢æŠ¬å¤´ï¼Œæœ¬å±€ä»¥ã€è¡¥è¯¾ç»“å±€ã€‘æ”¶åœºã€‚");
    },

    // ç»“ç®— / Game Over
    gameOver: (reason) => {
        if(game.state.gameOver) return;
        game.state.gameOver = true;
        sfx.alert();
        document.getElementById('controls').classList.add('hidden');
        document.getElementById('choice-btns').classList.add('hidden'); // æ”¶èµ·æ‰€æœ‰æˆ˜æ–—æŒ‰é’®
        document.getElementById('hud').style.opacity = 0.4;
        game.log(`âš°ï¸ æœ¬å±€ç»“æŸï¼š${reason}`, "system");
        game.checkAchievements(true);
        game.showSummary(reason);
    },

    showSummary: (reason) => {
        const s = game.stats;
        const p = game.player;
        const alliesCount = game.getAlliesCount();
        const summary = `
            <p>${reason}</p>
            <p>ğŸ“Š æœ¬å±€æ•°æ®ç®€æŠ¥ï¼š</p>
            <ul>
                <li>æ¢ç´¢æ¬¡æ•°ï¼š${s.explores} æ¬¡</li>
                <li>å’Œ NPC æ‰¯æ·¡ï¼š${s.chats} æ¬¡</li>
                <li>ä¸»åŠ¨å¼€æï¼š${s.fights} æ¬¡ï¼Œèƒœåˆ© ${s.wins} æ¬¡</li>
                <li>æˆåŠŸäº¤æ˜“ï¼š${s.trades} æ¬¡</li>
                <li>éšæœºäº‹ä»¶ï¼š${s.events} æ¬¡</li>
                <li>æœ€é«˜æŒæœ‰é‡‘å¸ï¼š${s.maxGold}</li>
                <li>æœ€ç»ˆç­‰çº§ï¼šLV.${p.lvl}ï¼Œæ”»å‡»åŠ›ï¼š${p.atk}</li>
                <li>å½“å‰åŒç›Ÿäººæ•°ï¼ˆå¥½æ„Ÿâ‰¥3ï¼‰ï¼š${alliesCount} äºº</li>
                <li>å¼€å±€å¤©èµ‹ï¼š${game.talentName || "ï¼Ÿï¼Ÿï¼Ÿ"}</li>
            </ul>
        `;
        document.getElementById('summary-text').innerHTML = summary;

        const achListDom = document.getElementById('ach-list');
        achListDom.innerHTML = "";
        achievementDB.forEach(a=>{
            const unlocked = !!game.achievementsUnlocked[a.id];
            const div = document.createElement('div');
            div.className = "ach-item" + (unlocked ? "" : " locked");
            div.innerHTML = `
                <div>
                    <div class="ach-name">${unlocked ? "âœ… " : "ğŸ”’ "}${a.name}</div>
                    <div style="font-size:12px;opacity:0.8;">${a.desc}</div>
                </div>
                <div class="ach-tag">${unlocked ? "å·²è§£é”" : "æœªè§£é”"}</div>
            `;
            achListDom.appendChild(div);
        });

        document.getElementById('end-modal').classList.remove('hidden');
        game.updateUI();
    },

    restart: () => {
        // è½¯é‡å¼€ï¼šä¸ç”¨åˆ·æ–°é¡µé¢ï¼Œé‡æ–°è¿›æŠ½äººè®¾
        game.init();
    },

    // æˆå°±æ£€æµ‹
    checkAchievements: (finalCheck=false) => {
        const g = game;
        // ç»Ÿè®¡å‹çŠ¶æ€æ›´æ–°
        g.stats.maxGold = Math.max(g.stats.maxGold, g.player.gold);
        if(g.player.hp>0 && g.player.hp<=10){
            g.stats.lowHpSurvive = true;
        }

        achievementDB.forEach(a=>{
            if(!g.achievementsUnlocked[a.id] && a.check(g)){
                g.achievementsUnlocked[a.id] = true;
                g.log(`ğŸ¥‡ æˆå°±è§£é”ï¼š${a.name} â€”â€” ${a.desc}`, "system");
            }
        });
        // æ›´æ–° HUD æˆå°±æ•°é‡
        document.getElementById('val-ach').innerText = Object.keys(g.achievementsUnlocked).length;
    },

    logCard: (npc, content, type) => {
        const s = document.getElementById('stage');
        s.innerHTML += `<div class="card ${type}"><div><strong>${npc.icon} ${npc.name}</strong></div>${content}</div>`;
        s.scrollTop = s.scrollHeight;
    },
    log: (msg, type) => {
        const s = document.getElementById('stage');
        s.innerHTML += `<div class="card ${type || "system"}">${msg}</div>`;
        s.scrollTop = s.scrollHeight;
    },

    updateUI: () => {
        const p = game.player;
        document.getElementById('val-hp').innerText = `${Math.max(0,Math.floor(p.hp))}/${p.maxHp}`;
        document.getElementById('hp-bar').style.width = Math.max(0,Math.min(100, p.hp/p.maxHp*100))+"%";
        document.getElementById('val-eng').innerText = p.energy;
        document.getElementById('eng-bar').style.width = Math.max(0,Math.min(100, p.energy))+"%";
        document.getElementById('val-gold').innerText = p.gold;
        document.getElementById('val-atk').innerText = p.atk;
        document.getElementById('val-lvl').innerText = p.lvl;
        document.getElementById('val-ach').innerText = Object.keys(game.achievementsUnlocked).length;
        document.getElementById('val-allies').innerText = game.getAlliesCount();
        document.getElementById('val-danger').innerText = Math.round(game.danger / game.maxDanger * 100);
    }
};

window.onload = () => game.init();
</script>
</body>
</html>
